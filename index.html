<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selektor WebRadio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script type="text/javascript"
      src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js">
  </script>
  <style>
    /* ------------------------------------------------------------------ */
    /* RESET & BASE                                                         */
    /* ------------------------------------------------------------------ */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primaryBlue:      #3B82F6;
      --secondaryIndigo:  #6366F1;
      --accentEmerald:    #10B981;
      --premiumGold:      #FBBF24;
      --surfaceDeepBlack: #0A0A0B;
      --surfaceGray:      #1A1A1B;
      --nebulaViolet:     #8B5CF6;
      --cosmicCyan:       #06B6D4;
      --stellarWhite:     #F8FAFC;
      --plasmaBlue:       #00D4FF;
      --energyPurple:     #AA66FF;
      --radarGreen:       #00FF88;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: var(--surfaceDeepBlack);
      font-family: 'Inter', sans-serif;
      color: var(--stellarWhite);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ------------------------------------------------------------------ */
    /* STAR FIELD CANVAS                                                   */
    /* ------------------------------------------------------------------ */
    #starfield {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    /* ------------------------------------------------------------------ */
    /* NEBULA GRADIENT LAYER                                               */
    /* ------------------------------------------------------------------ */
    #nebula {
      position: fixed;
      inset: 0;
      z-index: 1;
      background:
        radial-gradient(ellipse 70% 50% at 15% 20%, rgba(139, 92, 246, 0.12) 0%, transparent 60%),
        radial-gradient(ellipse 60% 40% at 85% 75%, rgba(59, 130, 246, 0.10) 0%, transparent 60%),
        radial-gradient(ellipse 50% 60% at 50% 50%, rgba(6, 182, 212, 0.06) 0%, transparent 70%);
      animation: nebulaDrift 30s ease-in-out infinite alternate;
    }

    @keyframes nebulaDrift {
      0%   { opacity: 0.6; transform: scale(1)    rotate(0deg); }
      33%  { opacity: 0.9; transform: scale(1.04) rotate(1deg); }
      66%  { opacity: 0.7; transform: scale(0.97) rotate(-1deg); }
      100% { opacity: 1.0; transform: scale(1.02) rotate(0.5deg); }
    }

    /* ------------------------------------------------------------------ */
    /* SAFE AREA WRAPPER (TV overscan)                                     */
    /* ------------------------------------------------------------------ */
    #app {
      position: fixed;
      inset: 5%;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* ------------------------------------------------------------------ */
    /* SCREENS                                                             */
    /* ------------------------------------------------------------------ */
    .screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.6s ease;
    }

    .screen.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* ------------------------------------------------------------------ */
    /* IDLE SCREEN                                                         */
    /* ------------------------------------------------------------------ */
    #screen-idle {
      gap: 32px;
    }

    .idle-logo-ring {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      border: 2px solid rgba(0, 212, 255, 0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      animation: idleRotate 20s linear infinite;
      box-shadow:
        0 0 40px rgba(0, 212, 255, 0.08),
        inset 0 0 40px rgba(0, 212, 255, 0.04);
    }

    .idle-logo-ring::before {
      content: '';
      position: absolute;
      inset: -8px;
      border-radius: 50%;
      border: 1px solid transparent;
      border-top-color: rgba(0, 212, 255, 0.4);
      border-right-color: rgba(170, 102, 255, 0.2);
      animation: idleRotate 8s linear infinite;
    }

    .idle-logo-ring::after {
      content: '';
      position: absolute;
      inset: -16px;
      border-radius: 50%;
      border: 1px solid transparent;
      border-bottom-color: rgba(139, 92, 246, 0.3);
      animation: idleRotate 14s linear infinite reverse;
    }

    @keyframes idleRotate {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    .idle-logo-img {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      animation: counterRotate 20s linear infinite;
    }

    @keyframes counterRotate {
      from { transform: rotate(0deg); }
      to   { transform: rotate(-360deg); }
    }

    .idle-title {
      font-size: 52px;
      font-weight: 800;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      background: linear-gradient(135deg, var(--plasmaBlue) 0%, var(--nebulaViolet) 50%, var(--energyPurple) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .idle-subtitle {
      font-size: 20px;
      font-weight: 300;
      color: rgba(248, 250, 252, 0.45);
      letter-spacing: 0.3em;
      text-transform: uppercase;
    }

    /* ------------------------------------------------------------------ */
    /* PLAYING SCREEN                                                      */
    /* ------------------------------------------------------------------ */
    #screen-playing {
      gap: 0;
      justify-content: center;
    }

    /* Artwork */
    .artwork-container {
      position: relative;
      width: 300px;
      height: 300px;
      margin-bottom: 44px;
      flex-shrink: 0;
    }

    /* Outer glow rings */
    .artwork-ring {
      position: absolute;
      border-radius: 50%;
      border: 1px solid transparent;
      animation: ringPulse 3s ease-in-out infinite;
    }

    .artwork-ring-1 {
      inset: -16px;
      border-color: rgba(0, 212, 255, 0.25);
      animation-delay: 0s;
    }

    .artwork-ring-2 {
      inset: -28px;
      border-color: rgba(170, 102, 255, 0.15);
      animation-delay: 0.6s;
    }

    .artwork-ring-3 {
      inset: -42px;
      border-color: rgba(139, 92, 246, 0.08);
      animation-delay: 1.2s;
    }

    @keyframes ringPulse {
      0%, 100% { opacity: 0.4; transform: scale(1);    }
      50%       { opacity: 1.0; transform: scale(1.02); }
    }

    /* Glassmorphism artwork circle */
    .artwork-glass {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: var(--surfaceGray);
      border: 2px solid rgba(0, 212, 255, 0.35);
      box-shadow:
        0 0 0 1px rgba(170, 102, 255, 0.15),
        0 0 60px rgba(0, 212, 255, 0.20),
        0 0 120px rgba(139, 92, 246, 0.12),
        inset 0 1px 0 rgba(255, 255, 255, 0.08),
        inset 0 0 40px rgba(0, 212, 255, 0.05);
      overflow: hidden;
      animation: artworkPulse 4s ease-in-out infinite;
    }

    @keyframes artworkPulse {
      0%, 100% {
        box-shadow:
          0 0 0 1px rgba(170, 102, 255, 0.15),
          0 0 60px rgba(0, 212, 255, 0.20),
          0 0 120px rgba(139, 92, 246, 0.12),
          inset 0 1px 0 rgba(255, 255, 255, 0.08),
          inset 0 0 40px rgba(0, 212, 255, 0.05);
      }
      50% {
        box-shadow:
          0 0 0 1px rgba(170, 102, 255, 0.30),
          0 0 80px rgba(0, 212, 255, 0.35),
          0 0 160px rgba(139, 92, 246, 0.20),
          inset 0 1px 0 rgba(255, 255, 255, 0.10),
          inset 0 0 60px rgba(0, 212, 255, 0.08);
      }
    }

    #artwork-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      display: block;
    }

    /* Default fallback artwork icon */
    .artwork-fallback {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 40% 35%, rgba(0, 212, 255, 0.15), rgba(139, 92, 246, 0.10), transparent 70%);
    }

    .artwork-fallback svg {
      width: 120px;
      height: 120px;
      opacity: 0.5;
    }

    /* Buffering overlay */
    #buffering-overlay {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: rgba(10, 10, 11, 0.70);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 5;
    }

    #buffering-overlay.visible {
      opacity: 1;
    }

    .spinner {
      width: 56px;
      height: 56px;
      border: 3px solid rgba(0, 212, 255, 0.15);
      border-top-color: var(--plasmaBlue);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Metadata */
    .metadata-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      width: 100%;
      max-width: 700px;
    }

    .live-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 255, 136, 0.12);
      border: 1px solid rgba(0, 255, 136, 0.35);
      border-radius: 100px;
      padding: 4px 14px 4px 10px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.12em;
      color: var(--radarGreen);
      text-transform: uppercase;
    }

    .live-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--radarGreen);
      box-shadow: 0 0 6px var(--radarGreen);
      animation: livePulse 1.4s ease-in-out infinite;
    }

    @keyframes livePulse {
      0%, 100% { opacity: 1;   transform: scale(1);    box-shadow: 0 0 6px var(--radarGreen); }
      50%       { opacity: 0.5; transform: scale(0.75); box-shadow: 0 0 2px var(--radarGreen); }
    }

    #station-name {
      font-size: 42px;
      font-weight: 800;
      color: var(--stellarWhite);
      letter-spacing: 0.01em;
      text-align: center;
      text-shadow: 0 0 40px rgba(0, 212, 255, 0.20);
      line-height: 1.15;
      max-width: 700px;
      /* Clip long names gracefully */
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    #now-playing {
      font-size: 22px;
      font-weight: 400;
      color: var(--plasmaBlue);
      text-align: center;
      letter-spacing: 0.02em;
      opacity: 0.9;
      max-width: 700px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.4;
      transition: opacity 0.5s ease;
    }

    #now-playing.empty {
      opacity: 0;
    }

    /* ------------------------------------------------------------------ */
    /* AUDIO VISUALIZER                                                    */
    /* ------------------------------------------------------------------ */
    #visualizer {
      position: fixed;
      bottom: 5%;
      left: 5%;
      right: 5%;
      height: 72px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 5px;
      z-index: 20;
      opacity: 0;
      transition: opacity 0.6s ease;
    }

    #visualizer.visible {
      opacity: 1;
    }

    .viz-bar {
      flex: 1;
      max-width: 14px;
      border-radius: 3px 3px 0 0;
      background: linear-gradient(
        to top,
        var(--plasmaBlue) 0%,
        var(--secondaryIndigo) 50%,
        var(--nebulaViolet) 100%
      );
      transform-origin: bottom center;
      will-change: transform;
    }

    /* ------------------------------------------------------------------ */
    /* BRANDING FOOTER                                                     */
    /* ------------------------------------------------------------------ */
    #branding {
      position: fixed;
      bottom: 5%;
      right: 5%;
      z-index: 30;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0.5;
    }

    .branding-text {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      background: linear-gradient(90deg, var(--plasmaBlue), var(--nebulaViolet));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .branding-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--nebulaViolet);
    }

    /* ------------------------------------------------------------------ */
    /* TRANSITIONS                                                         */
    /* ------------------------------------------------------------------ */
    .fade-slide-up {
      animation: fadeSlideUp 0.7s cubic-bezier(0.22, 1, 0.36, 1) both;
    }

    @keyframes fadeSlideUp {
      from { opacity: 0; transform: translateY(24px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

  <!-- Star field canvas -->
  <canvas id="starfield"></canvas>

  <!-- Nebula gradient layer -->
  <div id="nebula"></div>

  <!-- Main application wrapper (TV safe area) -->
  <div id="app">

    <!-- IDLE SCREEN -->
    <div id="screen-idle" class="screen active">
      <div class="idle-logo-ring">
        <img class="idle-logo-img" src="icon_512.png" alt="Selektor" onerror="this.style.display='none'">
      </div>
      <div class="idle-title">Selektor</div>
      <div class="idle-subtitle">WebRadio</div>
    </div>

    <!-- PLAYING SCREEN -->
    <div id="screen-playing" class="screen">

      <!-- Artwork -->
      <div class="artwork-container">
        <div class="artwork-ring artwork-ring-3"></div>
        <div class="artwork-ring artwork-ring-2"></div>
        <div class="artwork-ring artwork-ring-1"></div>
        <div class="artwork-glass">
          <div class="artwork-fallback" id="artwork-fallback">
            <!-- Radio wave icon SVG fallback -->
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C9.87 2 7.96 2.84 6.56 4.22L7.97 5.63C9.01 4.61 10.43 4 12 4C13.57 4 14.99 4.61 16.03 5.63L17.44 4.22C16.04 2.84 14.13 2 12 2Z" fill="#00D4FF"/>
              <path d="M12 6C10.67 6 9.47 6.55 8.6 7.44L10.01 8.85C10.52 8.32 11.22 8 12 8C12.78 8 13.48 8.32 13.99 8.85L15.4 7.44C14.53 6.55 13.33 6 12 6Z" fill="#AA66FF"/>
              <circle cx="12" cy="11" r="2" fill="#00D4FF"/>
              <path d="M12 14V22M10 22H14" stroke="#8B5CF6" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </div>
          <img id="artwork-img" src="" alt="" style="display:none;">
          <!-- Buffering overlay -->
          <div id="buffering-overlay">
            <div class="spinner"></div>
          </div>
        </div>
      </div>

      <!-- Metadata -->
      <div class="metadata-block">
        <div class="live-badge">
          <div class="live-dot"></div>
          Live
        </div>
        <div id="station-name">Loading...</div>
        <div id="now-playing" class="empty">—</div>
      </div>

    </div><!-- /screen-playing -->

  </div><!-- /app -->

  <!-- Audio visualizer (fixed at bottom) -->
  <div id="visualizer">
    <!-- Bars injected by JS -->
  </div>

  <!-- Branding footer -->
  <div id="branding">
    <div class="branding-dot"></div>
    <div class="branding-text">Selektor</div>
    <div class="branding-dot"></div>
  </div>

  <script>
    /* ================================================================== */
    /* 1. STAR FIELD                                                       */
    /* ================================================================== */
    (function initStarfield() {
      const canvas  = document.getElementById('starfield');
      const ctx     = canvas.getContext('2d');
      let stars     = [];
      let W, H;

      function resize() {
        W = canvas.width  = window.innerWidth;
        H = canvas.height = window.innerHeight;
      }

      function createStar() {
        const radius = Math.random() * 1.6 + 0.3;
        return {
          x:        Math.random() * W,
          y:        Math.random() * H,
          radius:   radius,
          baseAlpha: Math.random() * 0.7 + 0.2,
          alpha:    0,
          dAlpha:   (Math.random() * 0.004 + 0.001) * (Math.random() < 0.5 ? 1 : -1),
          // very slow drift
          dx:       (Math.random() - 0.5) * 0.04,
          dy:       (Math.random() - 0.5) * 0.04,
          color:    pickStarColor(),
        };
      }

      function pickStarColor() {
        const palette = [
          'rgba(248,250,252,',   // stellarWhite
          'rgba(0,212,255,',     // plasmaBlue
          'rgba(170,102,255,',   // energyPurple
          'rgba(139,92,246,',    // nebulaViolet
        ];
        return palette[Math.floor(Math.random() * palette.length)];
      }

      function build() {
        resize();
        // Density: ~1 star per 2400px²
        const count = Math.floor((W * H) / 2400);
        stars = [];
        for (let i = 0; i < count; i++) {
          const s = createStar();
          s.alpha = Math.random() * s.baseAlpha;
          stars.push(s);
        }
      }

      let raf;
      function tick() {
        ctx.clearRect(0, 0, W, H);
        for (const s of stars) {
          // Twinkle
          s.alpha += s.dAlpha;
          if (s.alpha >= s.baseAlpha) { s.alpha = s.baseAlpha; s.dAlpha *= -1; }
          if (s.alpha <= 0.05)        { s.alpha = 0.05;        s.dAlpha *= -1; }
          // Drift
          s.x += s.dx;
          s.y += s.dy;
          if (s.x < 0) s.x = W;
          if (s.x > W) s.x = 0;
          if (s.y < 0) s.y = H;
          if (s.y > H) s.y = 0;
          // Draw
          ctx.beginPath();
          ctx.arc(s.x, s.y, s.radius, 0, Math.PI * 2);
          ctx.fillStyle = s.color + s.alpha.toFixed(3) + ')';
          ctx.fill();
        }
        raf = requestAnimationFrame(tick);
      }

      window.addEventListener('resize', () => { cancelAnimationFrame(raf); build(); tick(); });
      build();
      tick();
    })();

    /* ================================================================== */
    /* 2. AUDIO VISUALIZER                                                 */
    /* ================================================================== */
    (function initVisualizer() {
      const container = document.getElementById('visualizer');
      const BAR_COUNT = 52;
      const bars      = [];

      for (let i = 0; i < BAR_COUNT; i++) {
        const bar = document.createElement('div');
        bar.className = 'viz-bar';
        bar.style.height = '4px';
        container.appendChild(bar);
        bars.push({
          el:        bar,
          target:    Math.random(),
          current:   0,
          speed:     Math.random() * 0.07 + 0.03,
          phase:     Math.random() * Math.PI * 2,
        });
      }

      const MAX_H   = 68; // px
      const MIN_H   = 3;
      let   isPlaying = false;
      let   time      = 0;

      function tick() {
        time += 0.012;
        for (let i = 0; i < bars.length; i++) {
          const b = bars[i];
          if (isPlaying) {
            // Multiple sine waves layered for organic feel
            const wave =
              Math.sin(time * 1.3 + b.phase) * 0.35 +
              Math.sin(time * 2.7 + i * 0.28) * 0.25 +
              Math.sin(time * 0.8 + i * 0.15) * 0.20 +
              Math.random() * 0.20;
            b.target = Math.max(0, Math.min(1, (wave + 0.5)));
          } else {
            b.target = 0;
          }
          b.current += (b.target - b.current) * b.speed;
          const h = MIN_H + b.current * (MAX_H - MIN_H);
          b.el.style.height = h.toFixed(1) + 'px';
        }
        requestAnimationFrame(tick);
      }

      tick();

      // Expose a setter for the Cast state machine
      window.setVisualizerPlaying = function(playing) {
        isPlaying = playing;
        const viz = document.getElementById('visualizer');
        if (playing) viz.classList.add('visible');
        else         viz.classList.remove('visible');
      };
    })();

    /* ================================================================== */
    /* 3. SCREEN MANAGEMENT                                                */
    /* ================================================================== */
    const Screens = {
      idle:    document.getElementById('screen-idle'),
      playing: document.getElementById('screen-playing'),
    };

    function showScreen(name) {
      Object.keys(Screens).forEach(key => {
        Screens[key].classList.toggle('active', key === name);
      });
    }

    /* ================================================================== */
    /* 4. UI UPDATE HELPERS                                                */
    /* ================================================================== */
    const artworkImg       = document.getElementById('artwork-img');
    const artworkFallback  = document.getElementById('artwork-fallback');
    const bufferingOverlay = document.getElementById('buffering-overlay');
    const stationNameEl    = document.getElementById('station-name');
    const nowPlayingEl     = document.getElementById('now-playing');

    function setArtwork(url) {
      if (url) {
        artworkImg.src = url;
        artworkImg.style.display = 'block';
        artworkFallback.style.display = 'none';
        artworkImg.onerror = function() {
          artworkImg.style.display = 'none';
          artworkFallback.style.display = 'flex';
        };
      } else {
        artworkImg.style.display = 'none';
        artworkFallback.style.display = 'flex';
      }
    }

    function setStationName(name) {
      stationNameEl.textContent = name || 'Selektor Radio';
    }

    function setNowPlaying(text) {
      if (text && text.trim()) {
        nowPlayingEl.textContent = text;
        nowPlayingEl.classList.remove('empty');
      } else {
        nowPlayingEl.textContent = '';
        nowPlayingEl.classList.add('empty');
      }
    }

    function setBuffering(on) {
      if (on) bufferingOverlay.classList.add('visible');
      else    bufferingOverlay.classList.remove('visible');
    }

    /* ================================================================== */
    /* 5. CAST RECEIVER SETUP                                              */
    /* ================================================================== */
    const context       = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();

    /* --- Error logging --- */
    playerManager.addEventListener(
      cast.framework.events.EventType.ERROR,
      (event) => { console.log('[SELEKTOR] CAST ERROR:', JSON.stringify(event)); }
    );

    playerManager.addEventListener(
      cast.framework.events.EventType.MEDIA_STATUS,
      (event) => { console.log('[SELEKTOR] MEDIA STATUS:', event.mediaStatus?.playerState); }
    );

    /* --- LOAD interceptor: force LIVE stream type --- */
    playerManager.setMessageInterceptor(
      cast.framework.messages.MessageType.LOAD,
      (loadRequestData) => {
        console.log('[SELEKTOR] LOAD REQUEST:', JSON.stringify(loadRequestData.media));
        if (loadRequestData.media) {
          loadRequestData.media.streamType = cast.framework.messages.StreamType.LIVE;
          if (!loadRequestData.media.contentType) {
            loadRequestData.media.contentType = 'audio/mpeg';
          }
        }
        return loadRequestData;
      }
    );

    /* ================================================================== */
    /* 6. PLAYER DATA BINDER (custom UI state tracking)                   */
    /* ================================================================== */
    const PlayerState = cast.framework.ui.State;

    const playerData   = new cast.framework.ui.PlayerData();
    const playerBinder = new cast.framework.ui.PlayerDataBinder(playerData);

    playerBinder.addEventListener(
      cast.framework.ui.PlayerDataEventType.ANY_CHANGE,
      (event) => {
        const data  = event.value;
        const state = playerData.state;
        console.log('[SELEKTOR] PlayerData change:', event.field, '| state:', state, '| value:', JSON.stringify(data));

        // --- Determine UI state ---
        const isPlaying    = state === PlayerState.PLAYING;
        const isBuffering  = state === PlayerState.BUFFERING || state === PlayerState.LOADING;
        const isMediaLoaded = (
          state === PlayerState.PLAYING ||
          state === PlayerState.PAUSED  ||
          state === PlayerState.BUFFERING ||
          state === PlayerState.LOADING
        );

        // --- Switch screens ---
        if (isMediaLoaded) {
          showScreen('playing');
        } else {
          showScreen('idle');
        }

        // --- Buffering overlay ---
        setBuffering(isBuffering && !isPlaying);

        // --- Visualizer ---
        if (window.setVisualizerPlaying) {
          window.setVisualizerPlaying(isPlaying);
        }

        // --- Metadata ---
        const media     = playerData.media;
        const metadata  = media && media.metadata;

        if (metadata) {
          const title    = metadata.title || metadata.stationName || '';
          const subtitle = metadata.subtitle || metadata.artist || metadata.nowPlaying || '';
          setStationName(title);
          setNowPlaying(subtitle);

          // Artwork
          const images = metadata.images;
          if (images && images.length > 0 && images[0].url) {
            setArtwork(images[0].url);
          } else {
            setArtwork(null);
          }
        } else if (isMediaLoaded) {
          // Media loaded but no metadata yet
          const url = media && (media.contentId || media.contentUrl);
          setStationName('Loading…');
          setNowPlaying('');
          setArtwork(null);
        }
      }
    );

    /* ================================================================== */
    /* 7. PLAYBACK CONFIG & START                                          */
    /* ================================================================== */
    const playbackConfig = new cast.framework.PlaybackConfig();
    playbackConfig.autoResumeDuration = 5;

    context.start({ playbackConfig: playbackConfig });
    console.log('[SELEKTOR] Cast Receiver started. Space theme active.');
  </script>
</body>
</html>
