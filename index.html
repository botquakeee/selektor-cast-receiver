<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Selektor Cast Receiver</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0b0f19; /* Selektor space dark blue */
      color: white;
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      overflow: hidden;
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* Background blurred art */
    #background-art {
      position: absolute;
      top: -10%;
      left: -10%;
      width: 120%;
      height: 120%;
      background-size: cover;
      background-position: center;
      filter: blur(40px) brightness(0.4);
      z-index: 0;
      transition: background-image 1s ease-in-out;
    }

    /* Main content container */
    #container {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: row;
      align-items: center;
      width: 100%;
      padding: 60px 80px;
      box-sizing: border-box;
    }

    /* Left side: Artwork */
    #art-container {
      flex: 0 0 auto;
      width: 500px;
      height: 500px;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0,255,255,0.2);
      overflow: hidden;
      background-color: #1a1a2e;
      border: 2px solid rgba(0,255,255,0.3);
    }

    #art-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: opacity 0.5s ease-in-out;
    }

    /* Right side: Metadata */
    #info-container {
      flex: 1 1 auto;
      margin-left: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      overflow: hidden; /* Needed for marquee */
    }

    /* Radio Station Name */
    #station-name {
      font-size: 40px;
      color: #00ffff; /* Cyan */
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 20px;
      text-shadow: 0 0 15px rgba(0,255,255,0.5);
    }

    /* Title Container for Marquee */
    .marquee-container {
      width: 100%;
      overflow: hidden;
      white-space: nowrap;
      position: relative;
      margin-bottom: 10px;
    }

    #track-title {
      font-size: 70px;
      font-weight: bold;
      color: white;
      display: inline-block;
    }

    /* Artist Container for Marquee */
    #track-artist {
      font-size: 45px;
      color: #b0b0b0;
      font-weight: 300;
      display: inline-block;
    }

    /* The Marquee Animation Classes */
    .animate-marquee {
      animation: marquee linear infinite;
      padding-left: 100%; /* Start off-screen */
    }

    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    /* Cast Media element (Hidden, audio only) */
    cast-media-player {
      display: none;
    }
  </style>
  
  <!-- Cast Application Framework API -->
  <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
</head>
<body>

  <div id="background-art"></div>
  
  <div id="container">
    <div id="art-container">
      <img id="art-image" src="" alt="Album Art">
    </div>
    <div id="info-container">
      <div id="station-name">Loading...</div>
      
      <div class="marquee-container" id="title-wrapper">
        <div id="track-title">Selektor Radio</div>
      </div>
      
      <div class="marquee-container" id="artist-wrapper">
        <div id="track-artist">Connecting...</div>
      </div>
    </div>
  </div>

  <cast-media-player></cast-media-player>

  <script>
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();

    // UI Elements
    const stationNameEl = document.getElementById('station-name');
    const trackTitleEl = document.getElementById('track-title');
    const trackArtistEl = document.getElementById('track-artist');
    const artImageEl = document.getElementById('art-image');
    const backgroundArtEl = document.getElementById('background-art');
    const titleWrapper = document.getElementById('title-wrapper');
    const artistWrapper = document.getElementById('artist-wrapper');

    let currentStationId = null;
    let updateInterval = null;

    // Helper to calculate reading speed for marquee
    function applyMarquee(element, wrapper) {
      // Reset animation
      element.classList.remove('animate-marquee');
      element.style.animationDuration = '0s';
      
      // Check if text is wider than container
      if (element.offsetWidth > wrapper.offsetWidth) {
        // Calculate duration based on width (e.g., 200 pixels per second)
        const duration = (element.offsetWidth + wrapper.offsetWidth) / 150;
        element.style.animationDuration = duration + 's';
        element.classList.add('animate-marquee');
      }
    }

    function updateUI(title, artist, coverUrl, stationName) {
      if (stationName) stationNameEl.textContent = stationName;
      
      trackTitleEl.textContent = title || 'Unknown Title';
      trackArtistEl.textContent = artist || 'Unknown Artist';
      
      if (coverUrl) {
        artImageEl.src = coverUrl;
        backgroundArtEl.style.backgroundImage = `url('${coverUrl}')`;
      }

      // Re-apply marquee if text is too long
      setTimeout(() => {
        applyMarquee(trackTitleEl, titleWrapper);
        applyMarquee(trackArtistEl, artistWrapper);
      }, 100);
    }

    // Function to fetch live metadata from AzuraCast API
    async function fetchMetadataFromAPI() {
      if (!currentStationId) return;

      try {
        const response = await fetch(`https://webradio.broadcast-technology.hu/api/nowplaying/${currentStationId}`);
        const data = await response.json();
        
        const nowPlaying = data.now_playing.song;
        const title = nowPlaying.title;
        const artist = nowPlaying.artist;
        const coverArt = nowPlaying.art;
        const stationName = data.station.name;

        updateUI(title, artist, coverArt, stationName);
      } catch (error) {
        console.error("Error fetching metadata:", error);
      }
    }

    // Intercept the LOAD request to extract customData and set up the polling
    playerManager.setMessageInterceptor(
      cast.framework.messages.MessageType.LOAD,
      request => {
        console.log('Intercepting LOAD request', request);

        // Extract our custom data sent from Flutter
        if (request.media && request.media.customData) {
          const customData = request.media.customData;
          
          if (customData.stationId) {
            currentStationId = customData.stationId;
            
            // Set initial UI from the phone's payload
            updateUI(
              customData.title, 
              customData.artist, 
              customData.coverArtUrl, 
              customData.stationName
            );

            // Start polling the API every 10 seconds independently!
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(fetchMetadataFromAPI, 10000);
          }
        }

        return request;
      }
    );

    // Clean up when playback stops
    playerManager.addEventListener(
      cast.framework.events.EventType.PLAYER_STATE_CHANGED,
      event => {
        if (event.value === 'IDLE' && event.reason === 'FINISHED') {
          if (updateInterval) clearInterval(updateInterval);
        }
      }
    );

    // Configure and start the receiver
    const options = new cast.framework.CastReceiverOptions();
    options.disableIdleTimeout = true; // Prevent TV from sleeping while listening to radio
    context.start(options);
  </script>
</body>
</html>
