<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selektor WebRadio Premium</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;600;800&display=swap" rel="stylesheet">
  <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <style>
    :root {
      --bg-color: #050505;
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.6);
      --accent: #E20074; /* App accent color */
    }
    
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body, html {
      width: 100%;
      height: 100%;
      background-color: var(--bg-color);
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      color: var(--text-main);
    }

    /* Dynamic Ambient Background */
    #ambient-bg {
      position: absolute;
      top: -10%;
      left: -10%;
      width: 120%;
      height: 120%;
      background-size: cover;
      background-position: center;
      filter: blur(120px) saturate(150%) brightness(0.7);
      opacity: 0.4;
      transition: background-image 2s ease-in-out, opacity 2s ease;
      z-index: 1;
    }

    #ambient-overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center, transparent 0%, #050505 85%);
      z-index: 2;
    }

    /* Main Container */
    #app-container {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* Screens */
    .screen {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 1s cubic-bezier(0.4, 0, 0.2, 1), transform 1s cubic-bezier(0.4, 0, 0.2, 1);
      transform: scale(0.95);
      width: 100%;
      height: 100%;
    }

    .screen.active {
      opacity: 1;
      visibility: visible;
      transform: scale(1);
    }

    /* Idle Screen */
    .idle-logo {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      animation: float 6s ease-in-out infinite;
    }
    
    .idle-title {
      margin-top: 30px;
      font-weight: 800;
      font-size: 48px;
      letter-spacing: 4px;
      background: linear-gradient(135deg, #fff, #a0a0a0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Playing Screen */
    .player-layout {
      display: flex;
      align-items: center;
      gap: 80px;
      max-width: 80%;
      width: 1000px;
    }

    /* Artwork with Glassmorphism & Reflection */
    .artwork-wrapper {
      position: relative;
      width: 400px;
      height: 400px;
      border-radius: 24px;
      perspective: 1000px;
    }

    .artwork {
      width: 100%;
      height: 100%;
      border-radius: 24px;
      object-fit: cover;
      box-shadow: 0 30px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.1);
      transition: transform 0.5s ease, box-shadow 0.5s ease;
      will-change: transform;
    }

    .artwork-fallback {
      width: 100%;
      height: 100%;
      border-radius: 24px;
      background: linear-gradient(135deg, #2a2a2a, #111);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 30px 60px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.1);
    }

    .artwork-fallback svg {
      width: 150px;
      height: 150px;
      fill: rgba(255,255,255,0.2);
    }

    /* Metadata */
    .metadata {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .badge-live {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(226, 0, 116, 0.15); /* Accent color */
      color: var(--accent);
      padding: 6px 16px;
      border-radius: 30px;
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 24px;
      width: fit-content;
      border: 1px solid rgba(226, 0, 116, 0.3);
    }

    .badge-live .dot {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    .title {
      font-size: 56px;
      font-weight: 800;
      line-height: 1.1;
      margin-bottom: 16px;
      text-shadow: 0 10px 30px rgba(0,0,0,0.5);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .subtitle {
      font-size: 28px;
      font-weight: 300;
      color: var(--text-muted);
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Visualizer / Equalizer */
    .visualizer {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      height: 60px;
      margin-top: 40px;
    }

    .bar {
      width: 6px;
      background: rgba(255,255,255,0.8);
      border-radius: 3px;
      height: 10%;
      transition: height 0.1s ease;
    }

    /* Buffering Overlay */
    .buffering {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s;
    }
    
    .buffering.active {
      opacity: 1;
      visibility: visible;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.1);
      border-left-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Animations */
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(226, 0, 116, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(226, 0, 116, 0); }
      100% { box-shadow: 0 0 0 0 rgba(226, 0, 116, 0); }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }
  </style>
</head>
<body>
  
  <div id="ambient-bg"></div>
  <div id="ambient-overlay"></div>

  <div id="app-container">
    
    <!-- IDLE SCREEN -->
    <div id="screen-idle" class="screen active">
      <img class="idle-logo" src="icon_512.png" alt="Selektor" onerror="this.src='https://webradio.broadcast-technology.hu/static/selektor_default_logo_1024.png'">
      <div class="idle-title">SELEKTOR</div>
    </div>

    <!-- PLAYING SCREEN -->
    <div id="screen-playing" class="screen">
      <div class="player-layout">
        
        <div class="artwork-wrapper">
          <img id="artwork" class="artwork" src="" style="display: none;">
          <div id="artwork-fallback" class="artwork-fallback">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-7.5c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
          </div>
          <div id="buffering" class="buffering">
            <div class="spinner"></div>
          </div>
        </div>

        <div class="metadata">
          <div class="badge-live">
            <div class="dot"></div>
            LIVE STREAM
          </div>
          <div id="title" class="title">Loading...</div>
          <div id="subtitle" class="subtitle">Selektor WebRadio</div>
          
          <div id="visualizer" class="visualizer">
            <!-- Bars generated via JS -->
          </div>
        </div>

      </div>
    </div>
  </div>

  <cast-media-player style="display: none;"></cast-media-player>

  <script>
    // ------------------------------------------------------------------
    // 1. VISUALIZER
    // ------------------------------------------------------------------
    const vizContainer = document.getElementById('visualizer');
    const bars = [];
    const NUM_BARS = 30;
    
    for(let i=0; i<NUM_BARS; i++) {
      const bar = document.createElement('div');
      bar.className = 'bar';
      vizContainer.appendChild(bar);
      bars.push(bar);
    }

    let vizInterval;
    function startVisualizer() {
      if(vizInterval) return;
      vizInterval = setInterval(() => {
        bars.forEach(bar => {
          const height = Math.random() * 90 + 10; // 10% to 100%
          bar.style.height = `${height}%`;
        });
      }, 150);
    }

    function stopVisualizer() {
      clearInterval(vizInterval);
      vizInterval = null;
      bars.forEach(bar => bar.style.height = '10%');
    }

    // ------------------------------------------------------------------
    // 2. UI UPDATERS
    // ------------------------------------------------------------------
    const screenIdle = document.getElementById('screen-idle');
    const screenPlaying = document.getElementById('screen-playing');
    const ambientBg = document.getElementById('ambient-bg');
    
    function setScreen(mode) {
      if(mode === 'playing') {
        screenIdle.classList.remove('active');
        screenPlaying.classList.add('active');
      } else {
        screenPlaying.classList.remove('active');
        screenIdle.classList.add('active');
        ambientBg.style.backgroundImage = 'none';
      }
    }

    function updateMetadata(title, subtitle, artUrl) {
      document.getElementById('title').textContent = title || 'Selektor Radio';
      document.getElementById('subtitle').textContent = subtitle || '';
      
      const img = document.getElementById('artwork');
      const fallback = document.getElementById('artwork-fallback');
      
      if(artUrl) {
        img.src = artUrl;
        img.style.display = 'block';
        fallback.style.display = 'none';
        ambientBg.style.backgroundImage = `url(${artUrl})`;
      } else {
        img.style.display = 'none';
        fallback.style.display = 'flex';
        ambientBg.style.backgroundImage = 'none';
      }
    }

    function setBuffering(isBuffering) {
      const el = document.getElementById('buffering');
      if(isBuffering) el.classList.add('active');
      else el.classList.remove('active');
    }

    // ------------------------------------------------------------------
    // 3. CAST RECEIVER SETUP & HACKS
    // ------------------------------------------------------------------
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();

    // ERROR LOGGING
    playerManager.addEventListener(
      cast.framework.events.EventType.ERROR,
      (event) => console.error('[SELEKTOR] CAST ERROR:', JSON.stringify(event))
    );

    // MESSAGE INTERCEPTOR - THE MAGIC FIX
    playerManager.setMessageInterceptor(
      cast.framework.messages.MessageType.LOAD,
      (loadRequestData) => {
        console.log('[SELEKTOR] LOAD REQUEST:', JSON.stringify(loadRequestData.media));
        if (loadRequestData.media) {
          // CRITICAL: Force stream to BUFFERED to avoid HLS/DASH strict validation for MP3
          loadRequestData.media.streamType = cast.framework.messages.StreamType.BUFFERED; 
          loadRequestData.media.contentType = 'audio/mpeg';
        }
        return loadRequestData;
      }
    );

    // ------------------------------------------------------------------
    // 4. PLAYER STATE BINDING
    // ------------------------------------------------------------------
    const playerData = new cast.framework.ui.PlayerData();
    const playerBinder = new cast.framework.ui.PlayerDataBinder(playerData);

    playerBinder.addEventListener(
      cast.framework.ui.PlayerDataEventType.ANY_CHANGE,
      (event) => {
        const state = playerData.state;
        const PlayerState = cast.framework.ui.State;

        const isPlaying = state === PlayerState.PLAYING;
        const isBuffering = state === PlayerState.BUFFERING || state === PlayerState.LOADING;
        const isMediaLoaded = (isPlaying || state === PlayerState.PAUSED || isBuffering);

        if(isMediaLoaded) setScreen('playing');
        else setScreen('idle');

        setBuffering(isBuffering && !isPlaying);

        if(isPlaying) startVisualizer();
        else stopVisualizer();

        if (playerData.media && playerData.media.metadata) {
          const meta = playerData.media.metadata;
          const title = meta.title || meta.stationName;
          const subtitle = meta.subtitle || meta.artist;
          const artUrl = meta.images && meta.images.length > 0 ? meta.images[0].url : null;
          updateMetadata(title, subtitle, artUrl);
        }
      }
    );

    // ------------------------------------------------------------------
    // 5. START
    // ------------------------------------------------------------------
    const playbackConfig = new cast.framework.PlaybackConfig();
    playbackConfig.autoResumeDuration = 5;

    context.start({ 
      playbackConfig: playbackConfig,
      supportedCommands: cast.framework.messages.Command.ALL_BASIC_MEDIA
    });
    console.log('[SELEKTOR] Ultra Premium Cast Receiver started.');

  </script>
</body>
</html>